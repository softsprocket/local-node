
function InputValueRequired (selectors, response) {
	this.selectors = selectors;
	this.response = response

	this.orig_color = {};
	for (each in this.selectors) {
		var el = this.selectors[each];
		this.orig_color[el] = $(el).css ('color');
	}
}

InputValueRequired.prototype.test_required = function (selectors) {
	var ok = true;
	
	if (!selectors) {
		selectors = this.selectors;
	}

	for (each in selectors) {
		var el = selectors[each];
		if ($(el).val () == '') {
			ok = false;
			$(el).css ('color', 'red');
			$(el).val ('required');
			$(el).focus (function (el) {
				$(el).css ('color', this.orig_color[el]);
				$(el).val ('');
				$(el).unbind ('focus');
			}.bind (this, el));
		}
	}

	if (!ok) {
		$(this.response).text ('Error: All fields are required');
	}

	return ok;
}

InputValueRequired.prototype.test_equal = function (selectors) {
	var ok = true;
	
	if (!selectors) {
		selectors = this.selectors;
	}

	var val;

	for (each in selectors) {
		var el = selectors[each];
		var val2 = $(el).val ();
		if (val) {
			if (val != val2) {
				ok = false;
			}
		} else {
			val = val2;
			continue;
		}
	}

	if (!ok) {
		$(this.response).text ('Error: Field values are not equal');
		for (each in selectors) {
			var el = selectors[each];
			$(el).css ('color', 'red');
			$(el).focus (function (selectors) {
				for (each in selectors) {
					var el = selectors[each];
					$(el).css ('color', this.orig_color[el]);
					$(el).unbind ('focus');
				}
			}.bind (this, selectors));
		}
	}

	return ok;
}






var set_login_callback = $.Callbacks ();

function Register (login) {
	this.login = login;
}

Register.prototype.listeners = function (selectors) {
	var self = this;

	set_login_callback.add (function (loggedin) {
		if (loggedin) { 
			$(selectors.register).hide ();
			$(selectors.menu).hide ();
		} else {
			$(selectors.menu).show ();
		}
	});

	var input_values = new InputValueRequired ([selectors.name, selectors.password, selectors.email, selectors.confirm_password], selectors.response);

	$(selectors.menu).click (function () {
		$(selectors.register).css ('display') == 'none' ?
			$(selectors.register).show ():
			$(selectors.register).hide ();

		return false;
	});

	$(selectors.register).submit (function (event) {
		event.preventDefault ();
	
		if (!input_values.test_required () || !input_values.test_equal ([selectors.password, selectors.confirm_password])) {
			return;
		}

		var send_data = {
            		'name': $(selectors.name).val (),
	            	'password': $(selectors.password).val (),
			'email': $(selectors.email).val ()
	        };
		
			
		console.log ("send_data", send_data);

		$.ajax ({
			type : 'POST',
			url: '/login',
			data: send_data, 
			dataType: 'json', 
			encode: true
		}).done (function (data) {
			console.log (data); 
			self.login.name = data.name;
			set_login_callback.fire (true);
			
		}).fail (function (err) {
			if (err.status == 403) {
				$(selectors.response).text ('User ' + send_data.name + ' already exists');
			} else {
				$(selectors.response).text ('!' + err.status + ' ' + err.statusText);
			}
		});

	});
}

function Login () {
	this.name;
}

Login.prototype.listeners = function (selectors) {
	var self = this;

	set_login_callback.add (function (loggedin) {
		if (loggedin) {
			$(selectors.login).hide ();
			$(selectors.menu).text ('logout');
		} else { 
			$(selectors.logout).hide ();
			$(selectors.menu).text ('login');
		}
	});

	var input_values = new InputValueRequired ([selectors.name, selectors.password], selectors.response);
	
	$(selectors.menu).click (function () {
		if ($(selectors.menu).text () == 'login') {
			$(selectors.login).css ('display') == 'none' ?
				$(selectors.login).show ():
				$(selectors.login).hide ();
		} else {
			$(selectors.logout).show ();
		}

		return false;
	});


	$(selectors.login).submit (function (event) {
		event.preventDefault ();
	
		if (!input_values.test_required ()) {
			return;
		}

		var login_data = {
            		'name': $(selectors.name).val (),
	            	'password': $(selectors.password).val ()
	        };

		$.ajax ({
			type : 'PUT',
			url: '/login',
			data: login_data, 
			dataType: 'json', 
			encode: true
		}).done (function (data) {
			console.log (data); 
			self.name = data.name;		
			set_login_callback.fire (true);
		}).fail (function (err) {
			if (err.status == 404) {
				$(selectors.response).text ('User ' + login_data.name + ' ' + err.statusText);
			} else {
				$(selectors.response).text (err.status + ' ' + err.statusText);
			}
		});

	});

	$(selectors.logout).submit (function (event) {
		event.preventDefault ();

		$.ajax ({
			type: 'GET',
			url: 'login'
		}).done (function () {
			console.log ('logout ok');
			set_login_callback.fire (false);
		}).fail (function (err) {
			$(selectors.response).text (err.status + ' ' + err.statusText);
		});
	});
}



null

var user_login = new Login ();
var user_register = new Register (user_login);

$(function () {
	
	var login_selectors = {
		menu: '#login_nav',
		login: '#user_login',
		logout: '#user_logout',
		name: '#user_name',
		password: '#user_password',
		response: '#user_login_resp'
	};

	user_login.listeners (login_selectors);

	var register_selectors = {
		menu: '#register_nav',
		register: '#user_register',
		name: '#user_reg_name',
		password: '#user_reg_password',
		confirm_password: '#user_reg_confirm_password',
		email: '#user_reg_email',
		response: '#user_register_resp'
	};

	user_register.listeners (register_selectors);


});

